---
title: "Git中submodule的使用"
date: 2021-02-07T15:57:48+08:00
draft: true
---

# 背景
在做下载模块时，因为2个app要用到同样的功能，为了方便代码的管理，引入子模块（submodule）的概念。主项目对子模块有依赖关系，但不关心子模块的内部开发流程细节。

Git的submodule功能就是建立了当前项目与子模块之间的依赖关系：子模块路径、子模块的远程仓库、子模块的版本号

## 使用流程

假设我们有两个项目：project-main和project-sub，其中project-main的远程仓库地址为https://github.com/username/project-main.git，而project-sub-1的远程仓库地址为https://github.com/username/project-sub.git。
接下来，我们希望在project-main中添加project-sub，而又保持project-sub的自身独立的版本控制。

1. 创建submodule

使用git submodule add <submodule_url>命令可以在项目中创建一个子模块。进入项目project-main，输入
git submodule add github.com/username/project-sub.git,
此时项目仓库中会多出两个文件：.gitmodules和project-sub.

.gitsubmodule就是子模块的相关信息；而后者那个文件，实际上保存的是子模块当前版本的版本号信息。

事实上，此时在.git/config文件中也会多出一些信息，在.git/modules文件夹下也会多出一份内容.

此时，主项目中会存在这个子模块的文件，但我们的xcode不知道怎么引用新模块，此时还需要自己手动添加下子模块文件夹的引用，这样子编译项目的时候，就可以找到这些文件了。

2. 获取submodule

上述步骤在创建子模块的过程中，会自动将相关代码克隆到对应路径，但对于后续使用者而言，对于主项目使用普通的clone操作并不会拉取到子模块中的实际代码。

如果希望子模块代码也获取到，一种方式是在克隆主项目的时候带上参数--recurse-submodules，这样会递归地将项目中所有子模块的代码拉取。

git clone github.com/username/project-main --recurse-submodules

此时project-main/project-sub文件夹应该有内容，并且固定在某个git提交的版本上。

另外一种可行的方式是，在当前主项目执行：
git submodule init
git submodule update
这两行命令会根据主项目的配置信息，拉取更新子模块中的代码。

3. 子模块内容的更新

对于子模块而言，并不需要知道引用自己的主项目的存在。对于自身来讲，子模块就是一个完整的git仓库，按照正常的git代码管理规范操作即可。

对于主项目而言，子模块的内容发生变动时，通常有三种情况：
1. 当前项目下子模块文件夹内的内容发生了未跟踪的内容变动；
2. 当前项目下子模块文件夹内的内容发生了版本变化
3. 当前项目下子模块文件夹内的内容没变，远程有更新

> 情况1: 子模块有未跟踪的内容变动

对于该情况，通常是在开发环境中，直接修改子模块文件夹中的代码导致的。

此时在主项目中使用git status能够看到关于子模块尚未暂存以备提交的变更，但是于主项目而言是无能为力的。

在此情景下，通常需要进入子模块文件夹，按照子模块内部的版本控制体系提交代码。

当提交完成后，主项目的状态则进入了情况2，即当前项目下子模块文件夹内的内容发生了版本变化。

> 情况2: 子模块有版本变化

当子模块版本变化时，在主项目中使用git status查看仓库状态时，会显示子模块有新的提交。

在这种情况下，可以使用git add/commit将其添加到主项目的代码提交中，实际的改动就是那个子模块文件所表示的版本信息。

通常当子项目更新后，主项目修改其所依赖的版本时，会产生类似这种情况的commit提交信息。

> 情况3: 子模块远程有更新

通常来讲，主项目与子模块的开发不会恰好是同时进行的。通常是子模块负责维护自己的版本升级后，推动到远程仓库，并告知主项目可以更新对子模块的版本依赖。

在这种情况下，主项目是比较茫然的。

前面提到过，主项目可以使用git submodule update更新子模块的代码，但那是指当前主项目文件夹下的子模块目录内容与当前主项目记录的子模块版本不一致时，会参考后者进行更新。

但如今这种情况下，后者 当前主项目记录的子模块版本 还没有变化，在主项目看来当前情况一切正常。

此时，需要让主项目主动进入子模块拉取新版代码，进行升级操作。

通常流程是：
cd project-sub
git pull origin master

子模块目录下的代码版本会发生变化，转到情况2的流程进行主项目的提交。

当主项目的子项目特别多时，可能会不太方便，此时可以使用git submodule的一个命令foreach执行：
git submodule foreach 'git pull origin master'

> 情况汇总

综上所述，可知在不同场景下子模块的更新方式如下：
1. 对于子模块，只需要管理好自己的版本，并推送到远程分支即可；
2. 对于父模块，若子模块版本信息未提交，需要更新子模块目录下的代码，并执行commit操作提交子模块版本信息；
3. 对于父模块，若子模块版本信息已提交，需要使用git submodule update，git会自动根据子模块版本信息更新所有子模块目录的相关代码。

4. 删除子模块

根据官方文档的说明，应该使用git submodule deinit命令卸载一个子模块。这个命令如果添加上参数--force，则子模块工作区内即使有本地的修改，也会被移除。

git submodule deinit proect-sub
git rm project-sub

## 总结

当项目比较复杂，部分代码希望独立为子模块进行版本控制时，可以使用git submodule功能。

使用git submodule功能时，主项目仓库并不会包含子模块的文件，只会保留一份子模块的配置信息及版本信息，作为主项目版本管理的一部分。

本文简单介绍了git submodule的添加和删除，以及项目开发过程中主项目与子模块不同状态时刻的操作方式。

### 开发中遇到的问题记录

问题1: 同事在执行完git submodule update命令后，子模块中的文件内容为空，具体原因是什么尚不清楚，但去子模块目录下手动执行

git checkout master

切换到使用的分支即可

问题2: 在合并分支或者提交自己写的代码之前，如果主项目提示子模块有改动而自己又没有动过子模块，一定要执行下git submodule update，如果自己没动过子模块，更新完子模块代码后，子模块改动提示应该会消失，假如还没消息，具体情况再具体分析。
